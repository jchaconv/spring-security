
Course: 
Spring Security Zero to Master along with JWT,OAUTH2

start: 28/11/2025


my repo: https://github.com/jchaconv/spring-security

course repo: https://github.com/eazybytes/spring-security


***************************
Section 1: Getting Started
***************************

- Create a spring boot project
    - java17, maven
    - spring boot 4.0.0
    - group: com.vilelo
    - artifact: springsec-section1
    - description: Demo project for Spring Boot and Spring Security
    - Dependencies: web, devtools

- Create a simple controller, run the app and go to http://localhost:8080/welcome
    - the log pattern format is interesting

- Secure the app:

    - add the spring-security dependency
    - rerun and there is no access to /welcome, it will show a login
    - user, and the password is in the console log
    - if i refresh the tab, the app is not asking the credentials again and again

    - i can add user.name and password in properties

- What is Security & Why it is important?

    - Similar to banks, our apps hold valuable data. Is necessary to secure the app in
      order to protect the data and business logic.

    -  Is a non functional requirement because no client ask for security in their app.
       Security is important as scalability, performance and availability.

    - Implement security from development phase. The earlier you implement security in your app
      the better app you build.

    - Security Is important because if we lose data, the business loss money.

    - Spring security helps to avoid common attacks.

    - Responsibility of the dev: the security of the web app layer.
        - Authentication
        - Authorization
        - Protection from exploits like CSRF, CORS, etc.


- Servlets & Filters

    - Everything in java web apps are driven by Servlets.
      The Servlet Container (Web Server, Tomcat the most used) converts the HTTP messages into ServletRequest(Java object),
      and deliver it to the Servlet method as a parameter. Also, receives the output of the
      ServletResponse.

      With spring framework we are just worry about coding the business logic and not of the servlet configurations.

    - Filters: intercept each request/response and do some pre work before business logic.

- Internal architecture of Spring Security  (* indicates that is a single component)

    - User entered credentials
    * Spring Security Filters, to identify if the user is authenticated
    * Authentication, is an object(username, password, isAuth=false) that represents the credentials
    * Authentication Manager, take the request and deliver it to the next component
    * Authentication Providers, using its components, this does the authentication(comparison)
        * UserDetailsManager/Service
        * Password Encoder

    * Security Context, if the auth is correct, the filter stores the session in this component
    - finally, filter sends a response.

- Demo of Spring Security internal flow (don't do it)

    - Logging trace in .properties
    - settings -> maven -> importing -> Automatically download (3 checks)
        - also, in the maven option(right hand), there are options to download source and docs
        - put a breakpoint inside doFilter method
        - do some navigation through lib classes.

    - JSESSIONID is the cookie that spring security save in the context and use it to validate the authentication.



********************************************************
Section 2: Changing the default security configurations
********************************************************

Services without security:
    - /contact
    - /notices

Services with security:
    - /myAccount
    - /myBalance
    - /myLoans
    - /myCards

    - Create project springsec-section2
    - Configuration class
    - don't use .permiteAll() 
    - after denyAll() we receive a 403
    - disable formLogin and httpBasic authentication


**********************************************************************
Section 3: Defining & Managing Users using InMemoryUserDetailsManager
**********************************************************************

branch: feature/section3-managing-users-in-memory

    - I used the pre-request option in postman, so I just need to put /myAccount
      to test the API, and provide the specified credentials in this exercise.

    Configuring users using InMemoryUserDetailsManager

        - delete username and password from properties
        - edit ProjectSecurityConfig
        - create UserDetailsService bean
        - use the InMemoryUserDetailsManager class
        - {noop}  --> indicates there is no password encoder
        - test with /myAccount

commit: f66b947815a23

--------------------------------------

    Configuring PasswordEncoder using PasswordEncoderFactories

        - To avoid the hardcoded password
        - BCrypt encoder by default
        - https://bcrypt-generator.com/
            - password: 5678  for the admin


commit: 969235f6897bb

--------------------------------------

    CompromisedPasswordChecker: To ask for a robust password

        - add bean CompromisedPasswordChecker on ProjectSecurityConfig
        - passwords are the same for user and admin Admin@3s12
        - not working for version changes.

        @Bean
        public CompromisedPasswordChecker compromisedPasswordChecker() {
            return new HaveIBeenPwnedRestApiPasswordChecker();
        }

        - finally I don't add this fragment.

--------------------------------------


******************************************************
Section 4: Defining & Managing Users using a Database
******************************************************

branch: feature/section4-managing-users-in-database


    - Creating MySQL Databse using Docker

        - using the Ubuntu distribution on windows 11
        - sudo apt install docker.io
        - sudo usermod -aG docker $USER    ---> adding my user to the docker group
        - newgrp docker  ----> this temporarily updates your current shell's group memberships without requiring a full logout.
        
        - in case of certficate error:

            - openssl s_client -connect registry-1.docker.io:443 -showcerts
            - sudo nano /usr/local/share/ca-certificates/proxy1.crt   ---> ctrl + o then ctrl + x
            - sudo nano /usr/local/share/ca-certificates/proxy2.crt
            - sudo nano /usr/local/share/ca-certificates/proxy3.crt
            - sudo update-ca-certificates
            - sudo service docker stop
            - sudo service docker start

        - docker pull mysql:latest
        - docker run -p 3306:3306 --name springsecurity -e MYSQL_ROOT_PASSWORD=root -e MYSQL_DATABASE=eazybank -d mysql

        - https://sqlectron.github.io/
            - name: springsecurity
            - localhost:3306
            - root:root



--------------------------------------

    - Understanding JdbcUserDetailsManager & creating Users inside the DB

        - use the querys from users.ddl without "ignorecase" (spring-security)
        - i saved this query on sql/script.sql

            create table users(username varchar(50) not null primary key,password varchar(500) not null,enabled boolean not null);
            create table authorities (username varchar(50) not null,authority varchar(50) not null,constraint fk_authorities_users foreign key(username) references users(username));
            create unique index ix_auth_username on authorities (username,authority);

        - execute the query inside the script file.


--------------------------------------


    - Using JdbcUserDetailsManager to perform authentication

        - add Dependencies to the project: jdbc, mysql and jpa
        - add connection properties
        - edit UserDetailsService adding  JdbcUserDetailsManager on ProjectSecurityConfig
        - user:EazyBytes@12345
        - successful test


--------------------------------------

    - Creating our own custom tables for Authentication
        - create table customer and insert rows
    
    - Creating JPA Entity and repository classes for new table
        - create model/Customer and use lombok
        - create CustomerRepository
        - add annotations on the main class. currently commented
    
    - Creating our own custom implementation of UserDetailsService
        - create config/EazyBankUserDetailsService
        - edit ProjectSecurityConfig, comment the jdbc manager.




--------------------------------------


    - Building a new REST API to allow the registration of new User

        - create controller/UserController
        - make public the endpoint in ProjectSecurityConfig
        - for transactions methods the framework enforces CSRF protection
            - edit the ProjectSecurityConfig
        - the test was successful with /register endpoint and no auth.



--------------------------------------


******************************************************
Section 5: Password Management with PasswordEncoders
******************************************************

branch: feature/section5-password-mngmnt-with-encoders

encode: no secure, just convert data from one form to another. Not the right option for password management.

    - prepare a plain.txt file with this value Jchacon@4432
    - openssl base64 -in plain.txt -out encode.txt
    - openssl base64 -d -in encode.txt -out decode.txt


encryption: Not the right option for password management.
    - transform data in such a way that guarantees confidentiality.
    - plain text -> encrypted text (cipher text) -> plain text  | encrypt and decrypt processes. 
    - suitable for encrpyt data in rest and at rest(ex: s3 bucket aws)
    - uses a key. guarantees confidentiality. encryption reversible by using the key.
        - symmetric: only one key for encrypt and decrypt
        - asymmetric: public key for encrypt and private key for decrypt. ideal for data in transit.

    - openssl enc -aes-256-cbc -pass pass:12345 -pbkdf2 -in plaint.txt -out encrpyt.txt -base64
    - openssl enc -aes-256-cbc -base64 -pass:12345 -d -pbkdf2 -in encrpyt.txt -out decrypt.txt


hashing: securily way to store passwords in database

    - input any kind of data and produce a unique string of bytes(Digest or Hash)
    - irreversibility, not possible to deduce the input, not possible to reverse the process to know the
      original input. Only 1 way.
    - the output hash value is always the same for a specific input.
    - typical approach to storing passwords, just store de hash value and compare them at the moment of login
    
    - PasswordEncoder interface and its popular implementations such as BCryptPasswordEncoder
    - DelegatingPasswordEncoder to delegates to the correct impl based on the prefix of the password. ex: {bcrypt}12345
    
    Drawbacks of hashing:
        - Brute force attack: calculate the hash value trying different plain text values. ex: calculate pin.
        - Dictionary or Rainbow attach: table with all possible combinations. millions of hash records.
        - Super fast: even for hackers, milliseconds.

    How to overcome Drawbacks:

        - limit the failed attempts
        - enforce the complexity of plaint text password
        
        - Salts during password hashing
            - password given by the client: 1234
            - salt value(random value): xyzm
            - total value given to the hash function: xyzm1234 ----> hash value: qwerty
            - saved value on database: salt + hash value ---> xyzmqwerty
            - when the login take place, the framework get the salt value with the plain text password and perform the hash function.
            - if the value matches with the stored in database, then the login is successful, otherwise it will be rejected.

        - use password hashing algorithms(bcrypt, scrypt, argo2 etc) to delay the process of hashing. It requires lots of cpu time and ram memory.
          the hacked may spend years to discover a robust password.

    Tests:

    - echo -n "Juliochaconv@12345" | openssl dgst -sha256     --> execute multiple times and the output is always the same
    
    - openssl dgst -sha256 jdk.*****.dmg     ---> to compare the hash value with the provide of oracle in the download link (sha-256)

    In the project I use the bcrypt algorithm with the passwordencoderdelegation in ProjectSecurityConfig class.


--------------------------------------

*********************************************************************
Section 6: Understanding Authentication Provider and Implementing it
*********************************************************************

branch: feature/section6-understanding-authentication-provider

- If we have a custom authentication requirement that is not fulfilled by Spring Security framework
  then we can build our own authentication logic by implementing the AuthenticationProvider interface.

- The ProviderManager identifies which is the appropiate Provider to authenticate a certain request
- we need to provide our own AuthenticationProvider
    - I think if there is an specific authentication requirements

- Check the interfaces and implementations:
    - Authentication
        - TestingAuthenticationProvider
    - AuthenticationProvider
    - ProviderManager (is a class)


---------------------------------

Implementing and Customizing the AuthenticationProvider inside our application

- tip: settings -> editor -> file types -> ignored files and folders
    - press + and after write press enter
        - .mvn
        - .idea
        - .gitignore
        - .gitattributes

- Create config.EazyBankUserPwdAuthenticationProvider
    - copy logic from AbstractUserDetailsAuthenticationProvider
    - in authenticate method is possible to add the specific authentication logic requirements

- run docker container and then start the app 

- To connect to MySQL from DBeaver, it is necessary to change this parameters in "Driver properties" option:
    - allowPublicKeyRetrieval=true
    - useSSL=false

- Test in debug mode
    - breakpoints in support and authenticate methods
    - invoke /myAccount  julio_chacon@epamneoris.com | ep4m55667
    - uncheck the "hide frames from libraries" option in debug mode
    - The default DaoAuthenticationProvider is relegated because of our own AuthenticationProvider
    - the success method is executed first and then the authenticate method
    - test successful

---------------------------------

Environment specific Security configurations using Profiles

- some changes in properties and a new profile file
- log: SpringsecSection2Application - The following 1 profile is active: "prod"
- config env variables. go to modify run configurations (from the start application class)
    - --spring.profiles.active=prod  --> this take precedence over the properties file, even if I have a different env active in that file
    - the environment configuration doesn't work. For now just use properties

- Create EazyBankUserPwdAuthenticationProvider equal(in content) to the existent and add this annotation:
    - @Profile("prod")
    - @Profile("!prod")  --> in the previous provider and delete the password validation
    - this means: "in lower environments don't validate the password. any value is ok"
    - test the application with default profile active. Any private endpoint is accessible with any credentials

- For now just create a new prod config for ProjectSecurityConfig

  ---------------------------------

*********************************************************************
Section 7: Spring Security customizations for most common use cases
*********************************************************************

branch: feature/section7-customization-most-common-use-cases

    - Most users use applications with https protocol ensures the data is properly secure
    - Accept only https protocol:
        - currently the app accepts both protocol. send a request and go to console in postman.

        - add properties
        - use updated configs in ProjectSecurityConfig
        - run this command and save the keystore on resources folder. The keystore will be generated on the command line path folder
            - keytool -genkeypair -alias tomcat -keyalg RSA -keysize 2048 -storetype PKCS12 -keystore keystore.p12 -validity 3650

        - then go to this url: https://localhost:8443/myAccount
        - the test is successful and http protocol is not allowed

  -----------------------

  Exception Handling in Spring Security framework

    - 401 unauthorized error
    - 403 forbidden error, properly authenticated but don't have enough privileges.

    To handle these errors:
        - ExceptionTranslationFilter
            - AuthenticationException (401) --> AuthenticationEntryPoint
            - AccessDeniedException   (403) --> AccessDeniedHandler
                                                    - AccessDeniedHandlerImpl (most used implementation)

------------------------

Defining Custom AuthenticationEntryPoint

    - Create CustomBasicAuthenticationEntryPoint class to handle 401
    - Copy the logic of BasicAuthenticationEntryPoint commence()
    - To link with spring security edit the ProjectSecurityConfig adding http.basic new configuration
        - this http-basic configuration works in the login but it has no impact in other places of the application

    - Test the changes with invalid user and no auth, you will se the custom message for 401:

    {
        "timestamp": "2025-12-13T11:09:48.580966800",
        "status": 401,
        "error": "Unauthorized",
        "message": "User details not found for the user: julio_chacon1@epamneoris.com",
        "path": "/myAccount"
    }

    {
        "timestamp": "2025-12-13T11:07:26.058352800",
        "status": 401,
        "error": "Unauthorized",
        "message": "Full authentication is required to access this resource",
        "path": "/myAccount"
    }

    - http.exceptionHandling() for a global configuration. It has impact in other places of the application.
        - the code is commented as a reference

-----------------------

Defining Custom AccessDeniedHandler

    - Implements AccessDeniedHandler in a new class CustomAccessDeniedHandler
    - Copy the same logic as CustomBasicAuthenticationEntryPoint and edit with FORBIDDEN status
    - edit ProjectSecurityConfig adding http.exceptionHandling with accessDeniedHandler function

    - test /myAccount1 with valid credentials:
        {
            "timestamp": "2025-12-13T11:28:17.660323400",
            "status": 403,
            "error": "Forbidden",
            "message": "Access Denied",
            "path": "/myAccount1"
        }

        * Is it more appropriate an 404 resource not found error?

    - it is possible to add .accessDeniedPage("/denied") to show ui page (if there is a ui view)
        - the code is commented as a reference

---------------------

Session Timeout & invalid session configurations

- default session time is activated (30 minutes)
- when a login is performed a cookie is created by spring security (JSESSIONID)
- edit in properties default env. No possible less than 2 minutes.
    -server.servlet.session.timeout=360   ---> seconds config
    -server.servlet.session.timeout=5m    ---> minutes config

- add this in ProjectSecurityConfig:
    http.sessionManagement(smc -> smc.invalidSessionUrl("/invalidSession"))  --> no exists so returns 404
    is to redirect to that url when the cookie expired

 - go to /myAccount in browser, wait for two minutos and refresh the page. Test successful

---------------------

Concurrent Session Control configurations

* This code is commented because test wasn't successful. It is a code valid for old versions.

- Edit ProjectSecurityConfig, in sessionManagement config:
    - maximumSessions(1)   ---> the first session is terminated when the second session starts. First session returns this when you try to refresh it:
                                "This session has been expired (possibly due to multiple concurrent logins being attempted as the same user)."

    - maxSessionsPreventsLogin(true)  ---> it returns 401 instead of "Maximum sessions of 1 for this principal exceeded"

    - it is possible to add .expiredUrl() to define a resource where the user will be redirect in case of multiple sessions


* New code provided by instructor as a solution of handle maximum number of sessions and the appropriate exception.
  It doesn't work either.

---------------------

Session Fixation Attack protection with Spring Security

    - Session Hijacking: A hacker steals the session Id from a web application
        - HTTPS to prevent this
    - Session Fixation: persuade another user to log in with the same session(by sending a link)
        - Spring security handles this attack by:
            - changeSessionId: not create a new session but instead changes the sessionId
            - newSession: new clean session is created without copying existing attributes
            - migrateSession: new session and copies all existing session attributes

        - no adding code is needed

---------------------

Listening Authentication Events

- Spring security fires events when authentication succeeds or fails by the use of:
    - DefaultAuthenticationEventPublisher, takes care of publishing evets (intern logic)
- I just need to use @EventListener to capture these events and execute business logic based
  on our requirements, by using these classes:
    - AuthenticationSuccessEvent
    - AbstractAuthenticationFailureEvent, it has many implementations
- Create the bean events.AuthenticationEvents.
- test a valid and invalid login, I can see the added logs of the bean class.

---------------------

Form Login Configurations for MVC or Monolithic apss

- New project eazy-school
- I think this security configuration is when you have a web interface in the project
- Useful for a full stack project
- You can use one of them:
    - defaultSuccessUrl
    - successHandler  --- provides more control
- important to add xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6" in html

- Spring security based on this:

    - SecurityContextHolder: Stores authenticated user details. Perform CRUD on SecurityContext. It uses ThreadLocal to provides security context to threads.
        - SecurityContext: It has the Authentication object stored
            - Authentication: This object is created in the process of login. It has a boolean like isAuthenticatedUser
                - Principal: name, username
                - Credentials: password
                - Authorities

- Holding strategies for the security context
    - MODE_THREADLOCAL: default
    - MODE_INHERITABLETHREADLOCAL: to copy the context details is other thread
    - MODE_GLOBAL: not for web apps


***********************
Section 8: CORS & CSRF
***********************

branch: feature/section8-cors-csrf

Attacks, only possible through the browsers:

CORS: Cross Origin Resource Sharing. Is a protocol. Block data transfer between different "origins".
      Is a protection provided by browser.

CSRF: Cross Site Request Forgery

There is a configuration on an angular application. I only see the demo.

@JsonIgnore  ---> to don't send this field to the client

Run the new script in section8 project and invoke some endpoints, in postman they will be ok.
But in angular application there is an invocation to /notices endpoint "access to 8080/notices from 4200 has been blocked by CORS policy"

There is a "preflight request" with OPTIONS operation and is like a validation of availability of the resource.

----------------------

Intro to CORS

    - Example: I'm in Peru and I received calls from the same country. I see the +51 identifier.
      But If I received a call from India, this is a special scenario, I'll be cautious and block the communication.

    - "Origins" a different scheme, domain or port

----------------------

Solution to handle CORS

    - Add at the ProjectSecurityConfig  class ---> http.cors(...)
        - @CrossOrigin(origins = "http://localhost:4200")  ---> will allow a specified domain
        - @CrossOrigin(origins = "*")  ---> will allow any domain
    - The test with the previous configuration was successful(video)

----------------------

CSRF protection inside Spring Security

    - What is the CSRF attack? perform an operation in web application on behalf of a user without their explicit consent.

    - When you access netflix, the site store a cookie on your browser, and it is attached to the domain netflix.com
    - a hacker sends a link with embeeded form(POST changeEmail netflix submit) the user perform this action. Then the user lost his access.
      Because, from it's own browser he performed an api netflix operation changing the user email.

    - In projectSecurityConfig there is a line:
        - .csrfConfig.disable()   --> this is the protection provided by spring security

    - The error is "Invalid CSRF token 'null' was found ..."
      Spring security throws 403 exception

-----------------------

Solution to handle CSRF attacks

    - secure random token to prevent CSRF attack -> CSRF token or XSRF
      unique per user session, difficult to guess

    - netflix backend server expects the cookie + CSRF token ... in this case the malicious website
      does not have the XSRF and Netflix throws an error 403.

    - XSRF can be attached in headers

-----------------------

Implementing CSRF token solution inside backend application

CSRFTokenRepository

- Create CsrfCookieFilter class
- .csrf() and .addFilterAfter()
- requireExplicitSave(false) --- no not save JSESSIONID
- SessionCreationPolicy.ALWAYS
- add CsrfTokenRequestHandler

- postman test:
- if you invoke GET then you receive the cookie and XSRF
- you need to provide the cookie(is Automatically) and the XSRF in the headers

- in the ui application there is some logic with XSRF-TOKEN  --> login.component.ts
- JSESSIONID + XSRF Token to get successful operations. First perform a login to store both cookies.


----------------

Ignoring CSRF protection for public APIs

- add the ignoringRequestMatchers with the public api's (below csrf configuration)

**************************************************************
Section 9: Implementing Authorization using Authorities, Roles
**************************************************************
branch: feature/section9-implementing-authorization

- Authentication
    - validate the identity of the user
    - 401 error response

- Authorization
    - validate privileges of the authenticated user
    - in other words user's authorities, privileges or roles are checked
      for accesing the resources
    - 403 error response
--------------------------
- GrantedAuthority interface handles authorities inside spring security
    - SimpleGrantedAuthority as impl. There are multiple places in the code where authorities are handled
--------------------------
Creating new table authorities to store multiple roles or authorities
- execute script about authorities(create table and inserts)
- create Authority and map with Customer
try with credentials /user:
    happy@example.com
    EazyBytes@54321
--------------------------
Configuring Authorities inside web application using Spring Security
- add Authorities in ProjectSecurityConfig with hasAuthority() and hasAnyAuthority()
    - there is an option with .access() -- accepts expressions
- test /myAccount?id=1 with happy user, this user has all authorities configured
--------------------------
Authority Vs Role in Spring Security

- Authority
    - individual privilege
    - restricting access in a fine-grained manner (VIEW_ACC, VIEW_CARDS)

- Role  → this is better when there are thousands of actions in the application
    - group of privileges
    - restricting access in a coarse-grained manner (ROLE_ADMIN, ROLE_USER)
--------------------------
Configuring Roles Authorization inside web application using Spring Security
- use just roles script on authorities table.
- Use hasRole or hasAnyRole.
* Remember, although it is shown in the table, the prefix "ROLE_" is not necessary
- test ok, 403 on acc service because SECRET role is not registered on happy user
--------------------------
Listening to the Authorization events

- create AuthorizationEvents
- use /register to create new user
- i see the event logs about 403 error

**********************************************
Section 10: Custom filters in spring security
**********************************************
branch: feature/section10-custom-filters

- Filters: Multiple of them intercept every request coming to our application
    - Each filter has its own responsibility(CSRF, CORS, authorization, etc)
    - They are executed as a chain filter → FilterChainProxy handles this
    - how to create our own filter and how to inject in the filter chain of execution

- add this to the main application class → @EnableWebSecurity(debug = true)
* Important: don't make this change in production application
- run the app in debug mode
- invoke /user api and see console logs, SecurityFilterChain
- add property to see more details from chain filter
--------------------------------------
How to create and configure our own custom filter
Adding a custom filter using addFilterBefore() method
    - Use interfaces: Filter(Jakarta), GenericFilterBean, OncePerRequestFilter
    - I need a new filter executed after the cors and csrf filter and before the basicAuthFilter. It will be RequestValidationBeforeFilter
    - add to ProjectSecurityConfig
    - test with username contains "test" to validate the filter - test ok I get a 400 bad request from the custom filter
--------------------------------------
Adding a custom filter using addFilterAfter() method
- AuthoritiesLoggingAfterFilter needs to be executed after the RequestValidationBeforeFilter
- add to the config with addFilterAfter  --- test ok with logs
--------------------------------------
Adding a custom filter using addFilterAt() method
- no guarantees of order execution. AuthoritiesLoggingAtFilter. add to config. test ok.

************************************************
Section 11: Token based authentication using JWT
************************************************
branch: feature/section11-token-based-auth-jwt

Opaque Tokens vs JSON Web Tokens (JWT)
- JSESSIONID allows not to enter username and password every single time I wanna access to the system
- XSRF-TOKEN sprint security protects of CSRF attacks
- How to transmit the backend to the UI application without using cookies?
- Auth Server(built with OAuth2): It has the security related logic
    - App1 invokes AuthServer and get the Opaque Token. App1 make a request(providing the Opaque token) to App2. App2 make a request to AuthServer to validate if Opaque token is valid.
    - App1 invokes  AuthServer and get the JWT. App2 self validate de JWT(contains auth info)  --- this is the advantage of JWT, not to make another call to AuthServer.
- Token formats:
    - Opaque: random string with no inherent meaning. use to reference the stored auth info on the server. It needs to be validated on each call.
    - JWT: self-contained token. contains header, payload and signature encoded in base64 url. can be validated locally using a public key.

Token Advantages:
    - Security: limited expose of user credentials
    - Expiration
    - Self-Contained
    - Reusability
        - Tokens can be used across different domains and services.
        - SSO-single sign on like Google with all its services. You need only one login.
    - Cross-Platform capability
    - Statelessness
        - no session state because token contains user information.
        - user don't need to being bounded to the same server to stay logged in on.
--------------------------------------
Deep dive about JWT Tokens
    - JSON format
    - useful for authentication and authorization
    - three parts separated by period (.)
        - Header: token metadata, encoding algorithm specification
        - Payload: user details, put the best effort to keep it light
        - Signature(optional): to make sure data is not tampered(manipulated)
                               generated by base64 of header, body and secret(stored in the backend)

    - go to jwt.io to understand more
--------------------------------------
Making project configuration to use JWT token

- use dependencies (3)
- edit ProjectSecurityConfig
    - not generate always the JESSSIONID, change for STATELESS
    - Remove securityContext config, just necessary for JESSIONID
    - allow a expose header "Authorization"
- Create JWTTokenGeneratorFilter and override method
- Create JWTTokenValidatorFilter and override method
- add those on filters config with after and before
- Add same config to prod configuration
--------------------------------------
Building logic to generate the JWT tokens
- generate token when auth is successful
- edit JWTTokenGeneratorFilter doFilterInternal
- 8 hrs expiration
--------------------------------------
Building logic to validate the JWT tokens
- edit JWTTokenValidatorFilter doFilterInternal
- this not activates its logic when the path is /user, so /user is like a login
--------------------------------------
Validating the JWT changes made by running the applications

- false the EnableWebSecurity on main class or just remove the parameter
- edit run config
    - enable env variables
    - SPRING_PROFILES_ACTIVE=default;JWT_SECRET=jxgEQeXHuPq8VdbyYFNkANdudQ53YUn4
- clear cookies on postman and invoke /user
- just XSRF-TOKEN is saved this time
- now I have the token Authorization in headers response
- use that token to invoke a private endpoint
- invoke /myAccount -- test ok
* when you copy the token and paste directly there is a line break, so be careful with it
--------------------------------------
JWT Expiration
- 30000000 = 8hrs
- 3000 = 3 secs
eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJFYXp5IEJhbmsiLCJzdWIiOiJKV1QgVG9rZW4iLCJ1c2VybmFtZSI6ImhhcHB5QGV4YW1wbGUuY29tIiwiYXV0aG9yaXRpZXMiOiJST0xFX0FETUlOLFJPTEVfVVNFUiIsImlhdCI6MTc2NzIyMzg2NiwiZXhwIjoxNzY3MjIzODc2fQ.3Z0-crWMcwatwiB_nGYH0PG1smiDa6pWH0_ivqIG23Q
--------------------------------------
Publish an AuthenticationManager for custom or manual authentication
- create apiLogin on UseController
- create records(classes with getters but no setters) for Login request and response
- create bean on ProjectSecurityConfig
- test ok with apiLogin

**********************************
Section 12: Method Level Security
**********************************
branch: feature/section12-method-level-security

@EnableMethodSecurity on top of java methods
To apply authorization rules
- Invocation authorization: validates if someone can invoke method based on role/authorities
- Filtering authorization: validates the method input and the output post business logic execution

prePostEnabled: enables @PreAuthorize and @PostAuthorize  -- use this
securedEnabled: enables @Secured -- legacy
jsr250Enabled: enables @RoleAllowed -- legacy

- add annotation to main project class
--------------------------------------
Details about method invocation authorization in method level security
- add this extra check enforce the security by adding checks in multiple layers of the application
- @PreAuthorize to check authorization before execute method logic
- @PostAuthorize after the execution of the method, so why is this necessary?
    - Maybe I have this getLoans() without request parameters, so I need to check the response
      If there is a username and matches a property, then the authorization is correct.
      ex: @PostAuthorize("returnObject.username == authentication.principal.username")

- Spring Security handles the methods invocation by AOP

- Logic related to these annotations on AuthorizationManager*MethodInterceptor
--------------------------------------
Demo of method level security using @PreAuthorize and @PostAuthorize

@PreAuthorize
    - edit /myLoans on ProjectSecurityConfig
    - edit LoanRepo
    - try to invoke api with correct user and then with other role --- test ok

@PostAuthorize
    - edit controller on the /myLoans api
    - the method is intercepted by the annotation and I get a 403 -- test ok
--------------------------------------
Details about filtering authorization in method level security
- Both annotations can be in the same method
- @PreFilter to validate input
- @PostFilter
--------------------------------------
Demo @PreFilter and @PostFilter
- edit in ContactController
- @PreFilter("filterObject.contactName != 'Test'")
    - If the name is Test, then the request body is empty -- test ok
- @PostFilter in the same endpoint, the result is the same

*************************************************
Section 13: Deep dive of OAuth2 & OpenID Connect
*************************************************

branch: feature/section13-oauth2-openid-connect

OAuth2(Open Authorization) is a framework(security standard) free and open source protocol, used to implement authentication
and authorization inside a web application. ex: Gmail Credentials are the same for all Google Products. You give one app
permission to access data in another app.

OAuth2 use a separate Auth Server for authentication and authorization. This server handles the user credentials for all products.

Problems that OAuth2 trying to solve:

- Imagine a bank with three apps(Loans, Cards, Accounts) without OAuth2. The client needs to handle credentials for each application.
  And every single security change needs to be done across all applications. The advantage of OAuth2 is that you can have separate the Auth Server with its logic
  from the Business Logic.

- Delegates the authentication and authorization. Imagine that you want to use a PhotoEdit(3rd party site) to edit your Google photos. Without OAuth2 you need to give
  the 3rd party site your Google credentials to give it permissions to access to your photos. But, the problem is that this site can perform some action on your behalf.
  Otherwise, with OAuth2 you don't need to give your credentials to the site. Google just authorize with limited permissions by using a temporary token, and this ensures a more secure interaction.
--------------------------------------
Introduction to OAUTH2

- oauth.net/2/
- Terminology
    - Resource Owner: The end user
    - Client: PhotoEditor
    - Authorization Server: store user credentials, performs auth
    - Resource Server
    - Scopes: Granular permissions the client wants

- Social login: With Google or Apple(Client id & client secret are used). Slack has this option.

--------------------------------------
Deep dive on Authorization code grant type flow in OAUTH2

* Basically consists in a communication between Client → Authz Server → Resource Server

- Authorization Code
    - Only when an end user is involved
    - Go to https://www.oauth.com/playground/
    - Each flow has its own steps

- PKCE
    - Proof key for code exchange
    - uses a code_verifier at the beginning of the flow and a code_challenge

- Client Credentials
- Device Code (IoT)

- Refresh Token
    - When the token is expired

- Implicit Flow (Legacy)
- Password Grant (Legacy)
--------------------------------------
Introduction to OpenID Connect

- OpenID Connect is a protocol that sits on top of the OAuth 2.0
- OIDC standardizes the scopes to openid, profile, email and address.
- ID Token using JWT
- Exposes /userinfo endpoint

- check this: https://www.oauth.com/playground/oidc.html

- IAM (Identity Access Management)
    - OpenID Connect → Authentication
    - OAuth 2.0 → Authorization

************************************************************************
Section 14: Implementing OAuth2 using spring security and social logins
************************************************************************

branch: feature/section14-implementing-oauth2

- create new project springsec-oauth2
    - dependencies: web, security, oauth2 client, oauth2 resource server
- mvc controller → html
- properties → until here, login with basic credentials on properties
- ProjectSecurityConfig → use ClientRegistration
    - CommonOAuth2Provider enum to see multiple social configs
    - Go to github → dev settings → oauth app → register
        - name: eazybytes
        - homepage and callback url: http://localhost:8080
        - client-id: Ov23li2g3dLB6GflXIxf
        - client-secret: 2a11895ce97376edf20d124a95fb4814840a3a6b
    - do the same process on facebook (i don't do this, the code is commented)
    - until here app start and configs ok

- add logic in controller to see values on username and oauth authentication objects
    - eazybytes | 12345

- You can use properties instead of beans on ProjectSecurityConfig
- tests ok with oauth2 login with github

***************************************************
Section 15: Securing app using OAuth2 and KeyCloak
***************************************************

branch: feature/section15-oauth2-keycloak

- Login auth servers
    - we can't control roles and authorities for our business. It has so many restrictions.

- Spring app as a Resource Server

- Keycloak
    - open source auth server
    - supports oauth2 and openid connect
    - realm: security domain to manage a set of users, credentials, roles, groups
    - client: app to be secured
    - user federation: link with external user db(ldap, active directory)
    - identity brokering: link with 3rd party id providers (google, facebook)
    - admin console
        - realm: space to handle a specific environment
        - client:

    - Now the client(postman) invokes my Auth Server(Keycloak)
    - An enterprise can build an Auth Server from scratch (spring auth server library)
      or using Products such as Keycloak(open source), Okta, auth0, AWS Cognito, etc.

    - Installation
        - keycloak.org  → normally, its on the devops team
        - docker commands:
            - command 8180:8080, start-dev: setups an in-memory database, add -d to detach mode
            - the port 8080 in that place is mandatory
            - docker pull quay.io/keycloak/keycloak:26.5.0
            - docker run -p 8180:8080 -d -e KC_BOOTSTRAP_ADMIN_USERNAME=admin -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin quay.io/keycloak/keycloak:26.5.0 start-dev
        - localhost:8180  → admin:admin  (takes some time to start the server
        - create realm → eazybankdev  → select the new realm
--------------------------------------
Register client with Client credentials grant type flow:

    - Clients → create client →
        - client id: eazybankapi
        - name: eazybankapi
        - cliente authentication: on
        - authentication flow: enable just "Service accounts roles"  ---> is the option for client credentials grant type flow
        - next → ignore url's and save
--------------------------------------
Convert spring app into a resource server
- springsection12 app --> take this and rename
- oauth2-resource-server dependency
- delete authentication providers
- KeycloakRoleConverter responsible for generates jwt token
- add the config to ProjectSecurityConfig and delete httpbasic and formlogin
- add properties and provide the auth server details
    - Configure → Realm settings → Endpoints: OpenID Endpoint Configuration → jwks_uri (different from video)
    - spring.security.oauth2.resourceserver.jwt.jwk-set-uri=${JWK_SET_URI:http://localhost:8180/realms/master/protocol/openid-connect/certs}

- Delete env variables(JWT_SECRET) from run config
- run app default with environment --- runs ok
--------------------------------------
- test public apis such as notices and contact
- /myAccount?email=happy@example.com ---> 401
    - OAuth2.0
        - token name: AccessToken
        - Grant type: Client Credentials
        - access token url: "token_endpoint" ---> the variable from openid config
        - client id: eazybankapi (from server)
        - client secret: (from server)
        - scope: openid email
        - Client authentication: send client credentials in body
        - get new access token (5 min expiration by default)
          → use token(this action saves in a postman variable)
          → send again the request
        - now the error is 403 because happy user has no roles assigned on server

- Go to Realm roles → create role → name: USER and ADMIN
- Go to Clients → eazybankapi → tab Service Account Roles → Assign role → Realm role → USER + ADMIN
- see the jwt before and after this role assignment on jwt.io, after roles addition this is the difference:
  "realm_access": {
      "roles": [
        "default-roles-master",
        "offline_access",
        "ADMIN",
        "uma_authorization",
        "USER"
      ]
  }
- test again → 200 ok
--------------------------------------
Demo with Opaque Tokens
* With Opaque config, a request is performed every time a client invokes the application(resource server)
- create KeycloakOpaqueRoleConverter
- comment the property of jwt openid config
- add three new properties
    - introspection_endpoint from openid_config
    - client-id and secret from another client on keycloak
- create new client → eazybankintrospect → Service accounts roles
- add config on ProjectSecurityConfig
- start app → get new accesstoken → stills the jwt format but the config is opaque
- I'm sure of that because I made a request the first time and it was ok
- Then I stopped the keycloak server and I received a 500 error after made a request again
- tests ok ---> opaque config is commented, jwt is more used by enterprises.
--------------------------------------
Creating Client and User details inside KeyCloak for Authorization code grant type flow
- Clients → create client →
    name: eazybankclient
    enables Client authentication
    flow: standard flow
    valid redirect uris: *
- Authentication → Policies → password policy → add
    - min length, uppercase, special characters, etc
- Users → create user →
    - username and email: happy@example.com
    - credentials → set password → Thas1*852
    - disable temporary option
    - for autom config: keycloak docs → admin REST API → users → (For now just manually config xd)

- postman (/myBalance) → configure new token
    - grant type: Authorization Code
    - check "Authorize using browser"
    - auth url: {{authorization_endpoint}}  from openid config
    - access token url: {{token_endpoint}}
    add client id and secret → get new access token (make sure browser is closed) → 403 (it's ok - no roles yet)

- User → user details → role mapping → Assign role → Realm roles
- if you want to edit token expiration: realm settings → access token lifespan
- with "Refresh" postman option a request to the auth server is performed
- Test ok in browser "Your call is authenticated"
--------------------------------------
Testing Authorization code PKCE grant types using Postman App

- When client cannot keep client secret safe (mobile apps, SPA)
- create client → eazypublicclient
    - DISABLE client authentication
    - standard flow enabled
    - pkce method: S256
    - valid redirect uris: *

- postman → /myCards → Grant type: Authorization code (With PKCE)
    - check "Authorize using browser"
    - auth url and token url same as before
    - client id: eazypublicclient
    - client secret blank
    - code challenge method: S256
    - get new access token → test ok